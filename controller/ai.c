/*** ai.c ***************************************************************/
/*                                                                      */
/*     Objet  : ai.h implementation                                     */
/*                                                                      */
/************************************************************************/

#include "../controller/ai.h"

static int pawnSq[2][10][8] = {
	{ // white pawn
		{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
		{ 1, 2, 3, 4, 0, 0, 4, 3, 2, 1 },
		{ 4, 4, 6, 12, 12, 12, 4, 6, 4, 3 },
		{ 2, 3, 4, 7, 18, 25, 25, 16, 7, 4, 3 },
		{ 5, 6, 11, 18, 27, 27, 16, 11, 6, 4 },
		{ 7, 10, 15, 24, 32, 32, 24, 15, 10, 7 },
		{ 7, 10, 15, 24, 32, 32, 24, 15, 10, 7 },
		{ 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000 } 
	},
	{ // black pawn
		{ 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000 }, 
		{ 7, 10, 15, 24, 32, 32, 24, 15, 10, 7 },
		{ 7, 10, 15, 24, 32, 32, 24, 15, 10, 7 },
		{ 5, 6, 11, 18, 27, 27, 16, 11, 6, 4 },
		{ 2, 3, 4, 7, 18, 25, 25, 16, 7, 4, 3 },
		{ 4, 4, 6, 12, 12, 12, 4, 6, 4, 3 },
		{ 1, 2, 3, 4, 0, 0, 4, 3, 2, 1 },
		{ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 }
	}
};

static int knightSq[2][10][8] = {
	{ // white knight 
		{ -15, -7, -3, 1, 3, 3, 1, -3, -7, -15 },
		{ -2, 2, 6,	14, 20,	20, 14, 6, 2, -2 },
		{ 3, 6, 14, 22, 26, 26, 22, 14, 6, 3 },
		{ 2, 8, 18, 26, 30, 30, 26, 18, 8, 2 },
		{ 2, 8, 18, 26, 30, 30, 26, 18, 8, 2 },
		{ 1, 6, 14, 28, 32, 32, 28, 14, 6, 1 },
		{ 0, 2, 6, 14, 20, 20, 14, 6, 2, 0 },
		{ -13, -7, -3, 1, 3, 3, 1, -3, -7, -13 }
	},
	{ // black knight
		{ -13, -7, -3, 1, 3, 3, 1, -3, -7, -13 },
		{ 0, 2, 6, 14, 20, 20, 14, 6, 2, 0 },
		{ 1, 6, 14, 28, 32, 32, 28, 14, 6, 1 },
		{ 2, 8, 18, 26, 30, 30, 26, 18, 8, 2 },
		{ 2, 8, 18, 26, 30, 30, 26, 18, 8, 2 },
		{ 3, 6, 14, 22, 26, 26, 22, 14, 6, 3 },
		{ -2, 2, 6,	14, 20,	20, 14, 6, 2, -2 },
		{ -15, -7, -3, 1, 3, 3, 1, -3, -7, -15 }
	}
};

static int bishopSq[2][10][8] = {
	{ // white bishop 
		{ 16, 16, 16, 16, 16, 16, 16, 16, 16, 16 },
		{ 24, 26, 29, 31, 31, 31, 31, 29, 26, 24 },
		{ 23, 26, 28, 32, 32, 32, 32, 28, 26, 23 },
		{ 6, 16, 26, 32, 32, 32, 32, 26, 16, 6 },
		{ 6, 16, 26, 32, 32, 32, 32, 26, 16, 6 },
		{ 6, 16, 28, 32, 32, 32, 32, 28, 16, 6 },
		{ 3, 16, 29, 31, 31, 31, 31, 29, 16, 3 },
		{ 16, 16, 16, 16, 16, 16, 16, 16, 16, 16 }
	},
	{ // black bishop 
		{ 16, 16, 16, 16, 16, 16, 16, 16, 16, 16 },
		{ 3, 16, 29, 31, 31, 31, 31, 29, 16, 3 },
		{ 6, 16, 28, 32, 32, 32, 32, 28, 16, 6 },
		{ 6, 16, 26, 32, 32, 32, 32, 26, 16, 6 },
		{ 6, 16, 26, 32, 32, 32, 32, 26, 16, 6 },
		{ 23, 26, 28, 32, 32, 32, 32, 28, 26, 23 },
		{ 24, 26, 29, 31, 31, 31, 31, 29, 26, 24 },
		{ 16, 16, 16, 16, 16, 16, 16, 16, 16, 16 }
	}
};

static int rookSq[2][10][8] = {
	{ // white rook 
		{ 0, 0, 0, 0, 3, 3, 0, 0, 0, 0 },
		{ -3, -2, 0, 0, 0, 0, 0, 0, -2, -3 },
		{ -3, -2, 0, 0, 0, 0, 0, 0, -2, -3 },
		{ -3, -2, 0, 0, 0, 0, 0, 0, -2, -3 },
		{ -3, -2, 0, 0, 0, 0, 0, 0, -2, -3 },
		{ -3, -2, 0, 0, 0, 0, 0, 0, -2, -3 },
		{ 10, 10, 10, 10, 10, 10, 10, 10, 10, 10 }, 
		{ 0, 0, 0, 0, 0, 0, 0, 0 }
	},
	{ // black rook 
		{ 0, 0, 0, 0, 0, 0, 0, 0 },
		{ 10, 10, 10, 10, 10, 10, 10, 10, 10, 10 }, 
		{ -3, -2, 0, 0, 0, 0, 0, 0, -2, -3 },
		{ -3, -2, 0, 0, 0, 0, 0, 0, -2, -3 },
		{ -3, -2, 0, 0, 0, 0, 0, 0, -2, -3 },
		{ -3, -2, 0, 0, 0, 0, 0, 0, -2, -3 },
		{ -3, -2, 0, 0, 0, 0, 0, 0, -2, -3 },
		{ 0, 0, 0, 0, 3, 3, 0, 0, 0, 0 }
	}
};

static int queenSq[2][10][8] = {
	{ // white queen 
		{ -2, -2, -2, 0, 0, -2, -2, -2,-2,-2 },
		{ 0,0, 0, 1, 1, 1, 0, 0, 0,0 },
		{ 0,0, 1, 1, 1, 1, 0, 0, 0,0 },
		{ 0,0, 0, 0, 2, 2, 0, 0, 0,0 },
		{ 0,0, 0, 0, 2, 2, 0, 0, 0,0 },
		{ -1,-2, -2, 0, 0, 0, 0, 0, 0,0 },
		{ -1,-2, -2, 0, 0, 0, 0, 0, 0,0 },
		{ -1,-2, -2, 0, 0, 0, 0, 0, 0,0 }
	},
	{ // black queen 
		{ -1,-2, -2, 0, 0, 0, 0, 0, 0,0 },
		{ -1,-2, -2, 0, 0, 0, 0, 0, 0,0 },
		{ -1,-2, -2, 0, 0, 0, 0, 0, 0,0 },
		{ 0,0, 0, 0, 2, 2, 0, 0, 0,0 },
		{ 0,0, 0, 0, 2, 2, 0, 0, 0,0 },
		{ 0,0, 0, 1, 1, 1, 0, 0, 0,0 },
		{ 0,0, 1, 1, 1, 1, 0, 0, 0,0 },
		{ -2, -2, -2, 0, 0, -2, -2, -2,-2,-2 },
	}
};

static int kingSq[2][10][8] = {
	{ // white king 
		{ 3,3,5, 8, -12, -8, -12, 10, 5,3 },
		{ -5,-5, -5, -12, -12, -12, -12, -5, -5,-5 },
		{ -7,-7, -15, -15, -15, -15, -15, -15, -7,-7 },
		{ -20,-20, -20, -20, -20, -20, -20, -20, -20,-20 },
		{ -20,-20, -20, -20, -20, -20, -20, -20, -20,-20 },
		{ -20,-20, -20, -20, -20, -20, -20, -20, -20,-20 },
		{ -20,-20, -20, -20, -20, -20, -20, -20, -20,-20 },
		{ -20,-20, -20, -20, -20, -20, -20, -20, -20,-20 }
	},
	{ //black king 
		{ -20,-20, -20, -20, -20, -20, -20, -20, -20,-20 },
		{ -20,-20, -20, -20, -20, -20, -20, -20, -20,-20 },
		{ -20,-20, -20, -20, -20, -20, -20, -20, -20,-20 },
		{ -20,-20, -20, -20, -20, -20, -20, -20, -20,-20 },
		{ -20,-20, -20, -20, -20, -20, -20, -20, -20,-20 },
		{ -7,-7, -15, -15, -15, -15, -15, -15, -7,-7 },
		{ -5,-5, -5, -12, -12, -12, -12, -5, -5,-5 },
		{ 3,3, 5, 8, -12, -8, -12, 10, 5,3 },
	}
};

static int archbishopSq[2][10][8]={
	{ // white archbishop 
		{ 16, 16, 16, 16, 16, 16, 16, 16 },
		{ 26, 29, 31, 31, 31, 31, 29, 26 },
		{ 26, 28, 32, 32, 32, 32, 28, 26 },
		{ 16, 26, 32, 32, 32, 32, 26, 16 },
		{ 16, 26, 32, 32, 32, 32, 26, 16 },
		{ 16, 28, 32, 32, 32, 32, 28, 16 },
		{ 16, 29, 31, 31, 31, 31, 29, 16 },
		{ 16, 16, 16, 16, 16, 16, 16, 16 }
	},
	{ // black archbishop 
		{ 16, 16, 16, 16, 16, 16, 16, 16 },
		{ 16, 29, 31, 31, 31, 31, 29, 16 },
		{ 16, 28, 32, 32, 32, 32, 28, 16 },
		{ 16, 26, 32, 32, 32, 32, 26, 16 },
		{ 16, 26, 32, 32, 32, 32, 26, 16 },
		{ 26, 28, 32, 32, 32, 32, 28, 26 },
		{ 26, 29, 31, 31, 31, 31, 29, 26 },
		{ 16, 16, 16, 16, 16, 16, 16, 16 }
	}
};

static int chancellorSq[2][10][8] = {
		{ // white chancellor 
		{ 16,16, 16, 16, 16, 16, 16, 16, 16,16 },
		{ 15,26, 29, 31, 31, 31, 31, 29, 26,15 },
		{ 15,26, 28, 32, 32, 32, 32, 28, 26,15 },
		{ 10,16, 26, 32, 32, 32, 32, 26, 16,10 },
		{ 10,16, 26, 32, 32, 32, 32, 26, 16,10 },
		{ 10,16, 28, 32, 32, 32, 32, 28, 16,10 },
		{ 10,16, 29, 31, 31, 31, 31, 29, 16,10 },
		{ 10,16, 16, 16, 16, 16, 16, 16, 16,10 }
	},
	{ // black chancellor 
		{ 10,16, 16, 16, 16, 16, 16, 16, 16,16 },
		{ 10,16, 29, 31, 31, 31, 31, 29, 16,16 },
		{ 10,16, 28, 32, 32, 32, 32, 28, 16,16 },
		{ 10,16, 26, 32, 32, 32, 32, 26, 16,16 },
		{ 10,16, 26, 32, 32, 32, 32, 26, 16,16 },
		{ 15,26, 28, 32, 32, 32, 32, 28, 26,15 },
		{ 15,26, 29, 31, 31, 31, 31, 29, 26,15 },
		{ 16,16, 16, 16, 16, 16, 16, 16, 16,16 }
	}
};


int evaluation(Chessboard ec) {
	int sum = 0, whiteBishop = 0, blackBishop = 0;
	Coordinates pos;
	int colorName = 0, n_time = 1; 
	for(pos.r = 0 ; pos.r < 8 ; pos.r++) for(pos.c = 0 ; pos.c < 10 ; pos.c++) {
		if(occupationTest(ec,pos)) {
			if(ec[pos.r][pos.c].color == 'B') {
				colorName = 32;
				n_time = 1;
			}
			else {
				colorName = 0;
				n_time = -1;
			}
			if(ec[pos.r][pos.c].piece == 'P'+colorName) {
				sum += n_time * 100;
				if(colorName) sum += pawnSq[0][pos.r][pos.c];
				else sum -= pawnSq[1][pos.r][pos.c];
			}
			else if(ec[pos.r][pos.c].piece == 'K'+colorName) {
				sum += n_time * 305;
				if(colorName) sum += knightSq[0][pos.r][pos.c];
				else sum -= knightSq[1][pos.r][pos.c];
			}
			else if(ec[pos.r][pos.c].piece == 'F'+colorName) {
				sum += n_time * 310;
				if(colorName) {
					sum += bishopSq[0][pos.r][pos.c];
					whiteBishop++;
				}
				else {
					sum -= bishopSq[1][pos.r][pos.c];
					blackBishop++;
				}
				
			}
			else if(ec[pos.r][pos.c].piece == 'T'+colorName) {
				sum += n_time * 485;
				if(colorName) sum += rookSq[0][pos.r][pos.c];
				else sum -= rookSq[1][pos.r][pos.c];
			}
			else if(ec[pos.r][pos.c].piece == 'D'+colorName) {
				sum += n_time * 950;
				if(colorName) sum += queenSq[0][pos.r][pos.c];
				else sum -= queenSq[1][pos.r][pos.c];
			}
			else if(ec[pos.r][pos.c].piece == 'R'+colorName) {
				if(colorName) sum += n_time * kingSq[0][pos.r][pos.c];
				else sum += n_time * kingSq[1][pos.r][pos.c];
				sum += n_time * 3000;
			}
			else if(ec[pos.r][pos.c].piece == 'F'+colorName) {
				if(colorName) sum += n_time * archbishopSq[0][pos.r][pos.c];
				else sum += n_time * archbishopSq[1][pos.r][pos.c];
				sum += n_time * 800;
			}
			else if(ec[pos.r][pos.c].piece == 'C'+colorName) {
				if(colorName) sum += n_time * chancellorSq[0][pos.r][pos.c];
				else sum += n_time * chancellorSq[1][pos.r][pos.c];
				sum += n_time * 850;
			}
		}
	}
	return sum;
}



void moveChoice(Chessboard ec, Color color, int profmax, Move *mcp) {
	int n_time = 1, best = 9999, x;
	Chessboard T;
	MoveList l, buffer;
	if(color == 'B') n_time = -1;
	best *= n_time;
	initList(&l);
	generator(ec,color,&l);
	removeCheck(ec,&l);
	buffer = l;
	while(!isEmpty(buffer)) {
		chessboardCopy(ec,T);
		executeMove(T,*buffer);
		x = minMax(T,opponentOf(color),profmax-1);
		
		srand(time(0));
		x += (int)rand()%10 - 5;
		
		if(n_time * x < n_time * best) {
			best = x;
			*mcp = *buffer;
		}
		buffer = buffer->next;
	}
	destroyList(ec,&l);
}

int minMax(Chessboard ec, Color camp, int profmax) {
	int n_time = 1, m, best = 9999;
	Move cp, mc;
	MoveList l, buffer;
	Chessboard T;
	if(!profmax) return evaluation(ec);
	else {
		if(camp == 'B') n_time = -1;
		best *= n_time;
		initList(&l);
		generator(ec,camp,&l);
		buffer = l;
		while(!isEmpty(buffer)) {
			chessboardCopy(ec,T);
			executeMove(T,*buffer);
			m = minMax(T,opponentOf(camp),profmax-1);
			if(n_time * m < n_time * best) {
				best = m;
				mc = cp;
			}
			buffer = buffer->next;
		}
		destroyList(ec,&l);
		return best;
	}
}

